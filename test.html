<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MichaelLLM Widget Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
    }

    /* Simulated Nav Header */
    .nav-header {
      background: white;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-brand {
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 1px;
      color: #1a202c;
    }

    .nav-links {
      display: flex;
      gap: 32px;
      align-items: center;
    }

    .nav-link {
      font-size: 13px;
      color: #4a5568;
      text-decoration: none;
      letter-spacing: 0.5px;
    }

    .nav-link:hover {
      color: #1a202c;
    }

    .chat-btn {
      background: #2d3748;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .chat-btn:hover {
      background: #4a5568;
    }

    /* Main Content */
    .main-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 60px 32px;
    }

    .hero {
      text-align: center;
      margin-bottom: 60px;
    }

    .hero h1 {
      font-size: 48px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 16px;
    }

    .hero p {
      font-size: 18px;
      color: #4a5568;
      line-height: 1.6;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #d1fae5;
      color: #065f46;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      margin-top: 24px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
    }

    footer {
      text-align: center;
      padding: 32px;
      color: #718096;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <!-- Simulated Webflow Nav -->
  <nav class="nav-header">
    <span class="nav-brand">MICHAEL ALDAMA | PRODUCT DESIGNER</span>
    <div class="nav-links">
      <a href="#" class="nav-link">WORK</a>
      <a href="#" class="nav-link">RESUME</a>
      <button class="chat-btn" onclick="toggleMichaelLLM()">Chat with AI</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="hero">
      <h1>MichaelLLM Test Page</h1>
      <p>Click "Chat with AI" to test the updated widget with typewriter animation.</p>
      <div class="status-badge">
        <span class="status-dot"></span>
        Widget Ready
      </div>
    </div>
  </main>

  <footer>
    MichaelLLM Widget Test Environment
  </footer>

  <!-- WIDGET CODE BELOW - Same as widget/embed.html -->
  <style>
/* MichaelLLM Widget Styles */
:root {
  --mllm-primary: #2D3748;
  --mllm-accent: #4A5568;
  --mllm-bg: #FFFFFF;
  --mllm-text: #1A202C;
  --mllm-text-light: #718096;
  --mllm-border: #E2E8F0;
  --mllm-user-bg: #F7F7F7;
  --mllm-width: 400px;
  --mllm-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  --mllm-coral: #E07B67;
}

#mllm-overlay {
  display: none;
}

#mllm-panel {
  position: fixed;
  top: 0;
  right: 0;
  width: var(--mllm-width);
  max-width: 100vw;
  height: 100vh;
  background: var(--mllm-bg);
  box-shadow: var(--mllm-shadow);
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

#mllm-panel.mllm-open {
  transform: translateX(0);
}

body.mllm-panel-open {
  margin-right: var(--mllm-width);
  transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
  transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@media (max-width: 768px) {
  body.mllm-panel-open {
    margin-right: 0;
  }
  #mllm-panel {
    width: 100vw;
  }
}

.mllm-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--mllm-border);
  flex-shrink: 0;
}

.mllm-header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.mllm-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--mllm-text);
  letter-spacing: 0.5px;
}

.mllm-info-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--mllm-text-light);
  padding: 4px;
  display: flex;
  align-items: center;
  position: relative;
}

.mllm-info-btn:hover {
  color: var(--mllm-text);
}

.mllm-tooltip {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--mllm-primary);
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 12px;
  line-height: 1.5;
  width: 240px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  z-index: 100;
  margin-top: 8px;
  text-align: left;
  font-weight: 400;
}

.mllm-info-btn:hover .mllm-tooltip,
.mllm-info-btn:focus .mllm-tooltip {
  opacity: 1;
  visibility: visible;
}

.mllm-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.mllm-refresh-btn,
.mllm-close-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--mllm-text-light);
  padding: 6px;
  display: flex;
  align-items: center;
  border-radius: 6px;
  transition: color 0.2s;
}

.mllm-refresh-btn:hover,
.mllm-close-btn:hover {
  color: var(--mllm-text);
}

.mllm-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.mllm-welcome {
  padding: 20px 0;
}

.mllm-welcome-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--mllm-text);
  margin-bottom: 24px;
}

.mllm-seeds {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.mllm-seed-btn {
  background: none;
  border: none;
  padding: 8px 0;
  text-align: left;
  font-size: 14px;
  color: var(--mllm-text-light);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  line-height: 1.4;
  transition: color 0.2s;
  position: relative;
}

.mllm-seed-btn:hover {
  color: var(--mllm-text);
}

.mllm-seed-arrow {
  color: var(--mllm-text-light);
  flex-shrink: 0;
  font-size: 14px;
}

.mllm-seed-btn:hover .mllm-seed-arrow {
  color: var(--mllm-text);
}

.mllm-hover-dot {
  width: 8px;
  height: 8px;
  background: var(--mllm-coral);
  border-radius: 50%;
  opacity: 0;
  transform: scale(0.5);
  transition: opacity 0.2s ease, transform 0.2s ease;
  margin-left: auto;
  flex-shrink: 0;
}

.mllm-seed-btn:hover .mllm-hover-dot,
.mllm-followup-btn:hover .mllm-hover-dot {
  opacity: 1;
  transform: scale(1);
}

.mllm-message {
  max-width: 100%;
  animation: mllm-fade-in 0.3s ease;
}

@keyframes mllm-fade-in {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.mllm-message-user {
  align-self: flex-end;
  max-width: 85%;
}

.mllm-message-bot {
  align-self: flex-start;
}

.mllm-message-user .mllm-bubble {
  background: var(--mllm-user-bg);
  color: var(--mllm-text);
  padding: 10px 16px;
  border-radius: 20px;
  font-size: 14px;
  line-height: 1.5;
  display: inline-block;
}

.mllm-message-bot .mllm-bubble {
  color: var(--mllm-text);
  font-size: 14px;
  line-height: 1.7;
  padding: 0;
}

.mllm-message-bot .mllm-bubble.mllm-typing-active {
  mask-image: linear-gradient(to right, #000 85%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, #000 85%, transparent 100%);
}

.mllm-message-bot .mllm-bubble strong {
  font-weight: 600;
}

.mllm-message-bot .mllm-bubble ul {
  margin: 8px 0;
  padding-left: 0;
  list-style: none;
}

.mllm-message-bot .mllm-bubble li {
  position: relative;
  padding-left: 16px;
  margin-bottom: 6px;
}

.mllm-message-bot .mllm-bubble li::before {
  content: "•";
  position: absolute;
  left: 0;
  color: var(--mllm-text);
  font-weight: bold;
}

.mllm-followups {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-top: 16px;
  padding-top: 8px;
}

.mllm-followup-btn {
  background: none;
  border: none;
  padding: 8px 0;
  text-align: left;
  font-size: 14px;
  color: var(--mllm-text-light);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: color 0.2s;
}

.mllm-followup-btn:hover {
  color: var(--mllm-text);
}

.mllm-followup-arrow {
  font-size: 14px;
  flex-shrink: 0;
}

.mllm-typing {
  display: flex;
  gap: 4px;
  padding: 8px 0;
  align-items: center;
}

.mllm-typing-dot {
  width: 8px;
  height: 8px;
  background: var(--mllm-coral);
  border-radius: 50%;
  animation: mllm-bounce 1.4s infinite ease-in-out both;
}

.mllm-typing-dot:nth-child(1) { animation-delay: -0.32s; }
.mllm-typing-dot:nth-child(2) { animation-delay: -0.16s; }
.mllm-typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes mllm-bounce {
  0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
  40% { transform: scale(1); opacity: 1; }
}

.mllm-rate-limit {
  background: #FEF3C7;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  margin: 16px 0;
}

.mllm-rate-limit-title {
  font-weight: 600;
  color: #92400E;
  margin-bottom: 4px;
}

.mllm-rate-limit-text {
  font-size: 14px;
  color: #B45309;
}

.mllm-input-area {
  padding: 16px 20px 24px;
  flex-shrink: 0;
}

.mllm-input-wrapper {
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 1px solid var(--mllm-border);
  padding-bottom: 8px;
}

.mllm-input {
  flex: 1;
  border: none;
  padding: 8px 0;
  font-size: 14px;
  font-family: inherit;
  resize: none;
  min-height: 24px;
  max-height: 120px;
  outline: none;
  background: transparent;
  color: var(--mllm-text);
}

.mllm-input::placeholder {
  color: var(--mllm-text-light);
}

.mllm-input:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.mllm-send-btn {
  background: none;
  border: none;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--mllm-text-light);
  transition: color 0.2s, transform 0.1s;
  flex-shrink: 0;
}

.mllm-send-btn:hover:not(:disabled) {
  color: var(--mllm-text);
}

.mllm-send-btn:active:not(:disabled) {
  transform: scale(0.95);
}

.mllm-send-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}
</style>

<div id="mllm-overlay" onclick="toggleMichaelLLM()"></div>

<div id="mllm-panel">
  <div class="mllm-header">
    <div class="mllm-header-left">
      <span class="mllm-title">MICHAELLLM</span>
      <button class="mllm-info-btn" aria-label="Info">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="mllm-tooltip">
          <strong>About MichaelLLM</strong><br><br>
          May contain hallucinations. Don't share sensitive info.<br><br>
          Responses are logged for research and development purposes.
        </div>
      </button>
    </div>
    <div class="mllm-header-right">
      <button class="mllm-refresh-btn" onclick="mllmReset()" aria-label="Reset conversation">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
      </button>
      <button class="mllm-close-btn" onclick="toggleMichaelLLM()" aria-label="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <div class="mllm-messages" id="mllm-messages"></div>

  <div class="mllm-input-area">
    <div class="mllm-input-wrapper">
      <textarea 
        class="mllm-input" 
        id="mllm-input" 
        placeholder="Ask about Michael..."
        rows="1"
        onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();mllmSend();}"
        oninput="this.style.height='24px';this.style.height=this.scrollHeight+'px';"
      ></textarea>
      <button class="mllm-send-btn" id="mllm-send-btn" onclick="mllmSend()" aria-label="Send">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="19" x2="12" y2="5"></line>
          <polyline points="5 12 12 5 19 12"></polyline>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const ENDPOINT = 'https://portfolio-chat-backend.vercel.app/api/chat';
  const TYPING_SPEED = 6;
  
  const SEED_PROMPTS = [
    "What are the 2–3 projects you're most proud of, and why?",
    "If I only read one case study, which should it be?",
    "What kind of problems do you love solving most?",
    "Tell me about a project where the constraints were brutal.",
    "What's a project where you simplified something complex?",
    "Walk me through your design process from kickoff to launch.",
    "How do you define the problem before jumping into solutions?",
    "How do you decide what to prototype vs what to ship?",
    "What does 'good UX' mean to you in practice?",
    "How do you approach design systems and consistency?",
    "How do you run user research when time is limited?",
    "Tell me about a time research changed your direction.",
    "How do you make decisions with imperfect information?",
    "What metrics do you use to judge success after launch?",
    "How do you work with engineers day-to-day?",
    "How do you influence product strategy without formal authority?",
    "Tell me about aligning stakeholders with different opinions.",
    "How do you give and receive feedback effectively?",
    "What kinds of roles are you looking for right now?",
    "What's the best way to contact you?"
  ];

  const RATE_LIMIT_KEY = 'mllm_rate_limit';
  const SESSION_KEY = 'mllm_session';
  const HISTORY_KEY = 'mllm_history';
  const MAX_MESSAGES = 20;
  const RATE_LIMIT_WINDOW = 30 * 60 * 1000;

  let isOpen = false;
  let isLoading = false;
  let isTyping = false;
  let history = [];
  let sessionId = '';
  let rateLimitData = { count: 0, windowStart: 0 };

  function init() {
    sessionId = localStorage.getItem(SESSION_KEY);
    if (!sessionId) {
      sessionId = 'sess_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
      localStorage.setItem(SESSION_KEY, sessionId);
    }

    try {
      const savedHistory = localStorage.getItem(HISTORY_KEY);
      if (savedHistory) history = JSON.parse(savedHistory);
    } catch (e) { history = []; }

    try {
      const savedRate = localStorage.getItem(RATE_LIMIT_KEY);
      if (savedRate) {
        rateLimitData = JSON.parse(savedRate);
        if (Date.now() - rateLimitData.windowStart > RATE_LIMIT_WINDOW) {
          rateLimitData = { count: 0, windowStart: Date.now() };
        }
      }
    } catch (e) { rateLimitData = { count: 0, windowStart: Date.now() }; }

    renderMessages();
  }

  window.toggleMichaelLLM = function() {
    isOpen = !isOpen;
    const panel = document.getElementById('mllm-panel');
    const overlay = document.getElementById('mllm-overlay');
    
    if (isOpen) {
      panel.classList.add('mllm-open');
      overlay.classList.add('mllm-open');
      document.body.classList.add('mllm-panel-open');
      setTimeout(() => document.getElementById('mllm-input').focus(), 300);
    } else {
      panel.classList.remove('mllm-open');
      overlay.classList.remove('mllm-open');
      document.body.classList.remove('mllm-panel-open');
    }
  };

  window.openMichaelLLM = function() { if (!isOpen) toggleMichaelLLM(); };
  window.closeMichaelLLM = function() { if (isOpen) toggleMichaelLLM(); };
  window.mllmReset = function() {
    history = [];
    localStorage.removeItem(HISTORY_KEY);
    renderMessages();
  };

  function renderMessages() {
    const container = document.getElementById('mllm-messages');
    
    if (isRateLimited()) {
      const remaining = Math.ceil((rateLimitData.windowStart + RATE_LIMIT_WINDOW - Date.now()) / 60000);
      container.innerHTML = renderRateLimitMessage(remaining);
      disableInput(true);
      return;
    }

    if (history.length === 0) {
      container.innerHTML = renderWelcome();
      return;
    }

    let html = '';
    history.forEach((msg, idx) => {
      html += renderMessageBubble(msg.role, msg.content, msg.id);
      if (msg.role === 'assistant' && idx === history.length - 1 && msg.followups && !isTyping) {
        html += renderFollowups(msg.followups);
      }
    });

    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
  }

  function renderWelcome() {
    const shuffled = [...SEED_PROMPTS].sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, 3);
    return `
      <div class="mllm-welcome">
        <div class="mllm-welcome-title">Hey there, I'm MichaelLLM.</div>
        <div class="mllm-seeds">
          ${selected.map(prompt => `
            <button class="mllm-seed-btn" onclick="mllmAsk('${escapeHtml(prompt)}')">
              <span class="mllm-seed-arrow">↳</span>
              <span>${escapeHtml(prompt)}</span>
              <span class="mllm-hover-dot"></span>
            </button>
          `).join('')}
        </div>
      </div>
    `;
  }

  function renderMessageBubble(role, content, id) {
    const className = role === 'user' ? 'mllm-message-user' : 'mllm-message-bot';
    const messageId = id || 'msg-' + Math.random().toString(36).substr(2, 9);
    return `<div class="mllm-message ${className}" id="${messageId}"><div class="mllm-bubble">${formatMessage(content)}</div></div>`;
  }

  function renderFollowups(followups) {
    if (!followups || followups.length === 0) return '';
    return `
      <div class="mllm-followups">
        ${followups.map(f => `
          <button class="mllm-followup-btn" onclick="mllmAsk('${escapeHtml(f)}', true)">
            <span class="mllm-followup-arrow">↳</span>
            <span>${escapeHtml(f)}</span>
            <span class="mllm-hover-dot"></span>
          </button>
        `).join('')}
      </div>
    `;
  }

  function renderTypingIndicator() {
    return `<div class="mllm-message mllm-message-bot" id="mllm-typing-indicator"><div class="mllm-typing"><div class="mllm-typing-dot"></div><div class="mllm-typing-dot"></div><div class="mllm-typing-dot"></div></div></div>`;
  }

  function renderRateLimitMessage(minutes) {
    return `<div class="mllm-rate-limit"><div class="mllm-rate-limit-title">Taking a quick break!</div><div class="mllm-rate-limit-text">Hey! I appreciate the curiosity, but I need a quick breather. Come back in about ${minutes} minutes and we can keep chatting!</div></div>`;
  }

  async function typewriterEffect(element, text, followups) {
    isTyping = true;
    const formattedText = formatMessage(text);
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = formattedText;
    const plainText = tempDiv.textContent || tempDiv.innerText;
    
    element.innerHTML = '';
    element.classList.add('mllm-typing-active');
    let currentIndex = 0;
    
    return new Promise((resolve) => {
      function typeNextChar() {
        if (currentIndex < plainText.length) {
          const char = plainText[currentIndex];
          element.textContent += char;
          currentIndex++;
          
          const container = document.getElementById('mllm-messages');
          container.scrollTop = container.scrollHeight;
          
          let delay = TYPING_SPEED;
          if (['.', '!', '?'].includes(char)) delay = TYPING_SPEED * 3;
          else if ([',', ';', ':'].includes(char)) delay = TYPING_SPEED * 1.5;
          
          setTimeout(typeNextChar, delay);
        } else {
          element.classList.remove('mllm-typing-active');
          element.innerHTML = formattedText;
          isTyping = false;
          
          if (followups && followups.length > 0) {
            const messageDiv = element.closest('.mllm-message');
            if (messageDiv) messageDiv.insertAdjacentHTML('afterend', renderFollowups(followups));
          }
          resolve();
        }
      }
      typeNextChar();
    });
  }

  window.mllmAsk = function(prompt, isFollowup = false) {
    document.getElementById('mllm-input').value = prompt;
    mllmSend(isFollowup ? prompt : null);
  };

  window.mllmSend = async function(clickedSuggestion = null) {
    if (isLoading || isTyping || isRateLimited()) return;

    const input = document.getElementById('mllm-input');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    input.style.height = '24px';

    if (rateLimitData.count === 0 || Date.now() - rateLimitData.windowStart > RATE_LIMIT_WINDOW) {
      rateLimitData = { count: 1, windowStart: Date.now() };
    } else {
      rateLimitData.count++;
    }
    localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(rateLimitData));

    if (isRateLimited()) { renderMessages(); return; }

    history.push({ role: 'user', content: message });
    renderMessages();

    isLoading = true;
    disableInput(true);
    const container = document.getElementById('mllm-messages');
    container.innerHTML += renderTypingIndicator();
    container.scrollTop = container.scrollHeight;

    try {
      const response = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message,
          history: history.slice(-10).map(m => ({ role: m.role, content: m.content })),
          session_id: sessionId,
          page_url: window.location.href,
          clicked_suggestion: clickedSuggestion
        })
      });

      const data = await response.json();
      const typingIndicator = document.getElementById('mllm-typing-indicator');
      if (typingIndicator) typingIndicator.remove();

      if (response.ok) {
        const msgId = 'msg-' + Math.random().toString(36).substr(2, 9);
        history.push({ role: 'assistant', content: data.reply, followups: data.followups || [], id: msgId });
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(-20)));

        container.innerHTML += `<div class="mllm-message mllm-message-bot" id="${msgId}"><div class="mllm-bubble"></div></div>`;
        const bubbleEl = document.querySelector(`#${msgId} .mllm-bubble`);
        await typewriterEffect(bubbleEl, data.reply, data.followups);
      } else {
        if (data.error === 'rate_limited') {
          rateLimitData.count = MAX_MESSAGES + 1;
          localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(rateLimitData));
        }
        history.push({ role: 'assistant', content: data.message || 'Sorry, something went wrong. Please try again!', followups: [] });
        renderMessages();
      }
    } catch (e) {
      console.error('MichaelLLM error:', e);
      const typingIndicator = document.getElementById('mllm-typing-indicator');
      if (typingIndicator) typingIndicator.remove();
      history.push({ role: 'assistant', content: "Hmm, I'm having trouble connecting. Please check your internet and try again!", followups: [] });
      renderMessages();
    }

    isLoading = false;
    disableInput(false);
    container.scrollTop = container.scrollHeight;
  };

  function isRateLimited() {
    if (Date.now() - rateLimitData.windowStart > RATE_LIMIT_WINDOW) return false;
    return rateLimitData.count >= MAX_MESSAGES;
  }

  function disableInput(disabled) {
    document.getElementById('mllm-input').disabled = disabled;
    document.getElementById('mllm-send-btn').disabled = disabled;
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
  }

  function formatMessage(content) {
    let safe = escapeHtml(content);
    safe = safe.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    safe = safe.replace(/__(.*?)__/g, '<strong>$1</strong>');
    safe = safe.replace(/^\d+\.\s+(.*)$/gm, '<li>$1</li>');
    safe = safe.replace(/^[\-\*]\s+(.*)$/gm, '<li>$1</li>');
    safe = safe.replace(/(<li>.*?<\/li>\s*)+/gs, '<ul>$&</ul>');
    safe = safe.replace(/\n(?!<)/g, '<br>');
    safe = safe.replace(/<br>\s*<ul>/g, '<ul>');
    safe = safe.replace(/<\/ul>\s*<br>/g, '</ul>');
    return safe;
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

</body>
</html>
